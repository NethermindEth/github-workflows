on:
  workflow_call:
    inputs:
      jfrog_url:
        description: 'URL of Artifactory server'
        type: string
        default: 'nethermind.jfrog.io'
      module_name:
        description: 'Name of Terraform module'
        type: string
        required: true
      module_version:
        description: 'Version of Terraform module'
        type: string
        required: true
    secrets:
      artifactory_access_token:
        description: 'A token used to communicate with Artifactory'
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: jfrog/setup-jfrog-cli@v4
      - name: Configure JFrog CLI
        shell: bash
        env:
          ARTIFACTORY_ACCESS_TOKEN: ${{ secrets.artifactory_access_token }}
          JFROG_URL: ${{ inputs.jfrog_url }}
        run: |
          echo "${ARTIFACTORY_ACCESS_TOKEN}" | jf config add nethermind \
            --url="https://${JFROG_URL}" \
            --interactive=false \
            --access-token-stdin
      - name: Configure Terraform registry
        shell: bash
        run: jf tfc --repo-deploy=local-angkor-terraform-module
      - name: Publish Terraform module
        shell: bash
        run: |
          mkdir -p package
          rsync -Rr --exclude=".*" --exclude="package" ./ package/${{ inputs.module_name }}
          cd package/${{ inputs.module_name }}
          jf terraform publish \
            --namespace=nethermind \
            --provider=saas \
            --tag ${{ inputs.module_version }}
